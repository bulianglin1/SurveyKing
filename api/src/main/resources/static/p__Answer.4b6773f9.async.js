(self.webpackChunksurvey_king=self.webpackChunksurvey_king||[]).push([[6637],{78210:function(me,H,t){"use strict";var j=t(27856),D=t.n(j),G=t(15020),P=t(85893),S=function(N){var $=N.html,f=$===void 0?"":$,W=N.replaceP,X=W===void 0?!0:W;return X?(0,P.jsx)("div",{className:"pe-view",children:typeof f=="string"&&(0,G.ZP)(D().sanitize(f,{ADD_TAGS:["iframe"],ADD_ATTR:["allow","allowfullscreen","frameborder","scrolling"]}).replace(/<p>/,"<span>").replace(/<\/p>/,"</span>"))}):(0,P.jsx)(P.Fragment,{children:typeof f=="string"&&(0,G.ZP)(D().sanitize(f))})};H.Z=S},79662:function(me,H,t){"use strict";t.r(H),t.d(H,{MobileOrPC:function(){return ae},default:function(){return De}});var j=t(39428),D=t(3182),G=t(71194),P=t(50146),S=t(11849),ie=t(68068),N=t(9761),$=t(42277),f=t(67294),W=t(51615),X=t(92725),Y=t(12997),Be=t(49111),ge=t(19650),Ne=t(57663),q=t(71577),pe=t(94657),b=t(3980),we=t(27400),ye=t(73727),je=t(49914),O=t(96389),r=t(85893),Se=(0,N.Pi)(function(){var y,o,e=(0,je.H)(),l=(0,we.a)(),i=e.success,u=(y=e.setting)===null||y===void 0?void 0:y.submittedSetting,g=(o=e.setting)===null||o===void 0?void 0:o.answerSetting.loginRequired,n=e.survey,h=e.id,C=(0,f.useMemo)(function(){return n?(0,O.R6)(n):{}},[n]),x=u||{},I=x.contentHtml,m=x.redirectUrl,a=x.answerAnalysis,R=x.rankVisible,F=x.transcriptVisible,V=e.answerId,L=e.answerQrCodeUrl,U=e.answerView,v=e.values;(0,f.useEffect)(function(){if(m&&v){if(!m.includes("(")){window.location.href=m;return}var A=(0,O.vW)(m,function(E){var K=(0,O.Op)(E),J=(0,pe.Z)(K,2),_=J[0],oe=J[1],ee=v[_];return(0,O.d0)(C,ee,E)});A.success&&(window.location.href=A.result)}},[m,v]),(0,f.useEffect)(function(){i&&n&&v&&U&&(0,O.MA)(n,I,v,U.examScore)},[I,i,n,v,U]);var Q=function(){var E="";return a&&R?E="\u67E5\u770B\u6392\u540D\u53CA\u89E3\u6790":R?E="\u67E5\u770B\u8003\u8BD5\u6392\u540D":(a||F)&&(E="\u67E5\u770B\u7B54\u6848\u89E3\u6790"),E?(0,r.jsx)("div",{children:(0,r.jsx)(q.Z,{onClick:function(){return window.open("/s/".concat(h,"/exam-result/").concat(V))},children:E})}):(0,r.jsx)(r.Fragment,{})};return i?(0,r.jsx)("div",{className:"survey-end animated",children:(0,r.jsx)("div",{className:"survey-end-content",children:(0,r.jsx)("h3",{className:"survey-end-title ",children:(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{id:"result-message"}),Q(),(0,r.jsx)("div",{children:g&&(0,r.jsxs)(ge.Z,{children:[(0,r.jsx)(ye.rU,{to:"/",children:(0,r.jsx)(q.Z,{type:"link",onClick:function(){},children:"\u8FD4\u56DE\u9996\u9875"})}),(0,r.jsx)(q.Z,{type:"link",onClick:function(){l.logout(),(0,b.on)()},children:"\u9000\u51FA\u5173\u95ED"})]})})]})})})}):(0,r.jsx)(r.Fragment,{})}),Ce=Se;function Ie(y){return f.createElement("svg",Object.assign({width:"1em",height:"1em",viewBox:"0 0 48 48",xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink"},y,{style:Object.assign({verticalAlign:"-0.125em"},y.style),className:["antd-mobile-icon",y.className].filter(Boolean).join(" ")}),f.createElement("g",{id:"ExclamationCircleFill-ExclamationCircleFill",stroke:"none",strokeWidth:1,fill:"none",fillRule:"evenodd"},f.createElement("g",null,f.createElement("rect",{id:"ExclamationCircleFill-\u77E9\u5F62",fill:"#D76060",opacity:0,x:0,y:0,width:48,height:48}),f.createElement("path",{d:"M24,2 C36.1502645,2 46,11.8497355 46,24 C46,36.1502645 36.1502645,46 24,46 C11.8497355,46 2,36.1502645 2,24 C2,11.8497355 11.8497355,2 24,2 Z M25.1,31 L22.9,31 C22.6790861,31 22.5,31.1790861 22.5,31.4 L22.5,31.4 L22.5,33.6 C22.5,33.8209139 22.6790861,34 22.9,34 L22.9,34 L25.1,34 C25.3209139,34 25.5,33.8209139 25.5,33.6 L25.5,33.6 L25.5,31.4 C25.5,31.1790861 25.3209139,31 25.1,31 L25.1,31 Z M25.1,14 L22.9,14 C22.6790861,14 22.5,14.1790861 22.5,14.4 L22.5,14.4 L22.5,27.6 C22.5,27.8209139 22.6790861,28 22.9,28 L22.9,28 L25.1,28 C25.3209139,28 25.5,27.8209139 25.5,27.6 L25.5,27.6 L25.5,14.4 C25.5,14.1790861 25.3209139,14 25.1,14 L25.1,14 Z",id:"ExclamationCircleFill-\u5F62\u72B6\u7ED3\u5408",fill:"currentColor",fillRule:"nonzero"}))))}var xe=Ie,z=t(78210),We=t(34792),se=t(48086),Oe=t(69610),Le=t(54941),s=t(54531),ne=t(36855),Ee=t(42238),Te=t.n(Ee),Ze=function(){function y(o){var e;(0,Oe.Z)(this,y),this.id=void 0,this.project=void 0,this.survey=void 0,this.loading=void 0,this.verifying=!1,this.saving=!1,this.isPC=void 0,this.errorCode=void 0,this.errorMessage=void 0,this.progress=0,this.confirmTempAnswerType=0,this.statistics=void 0,this.answerUrl=void 0,this.answerQrCodeUrl=void 0,this.loginRequired=void 0,this.whitelistName=void 0,this.success=void 0,this.answerId=void 0,this.answerView=void 0,this.values=void 0,this.openId=void 0,this.token=void 0,this.surveyRef=void 0,this.id=o.id,this.answerId=o.answerId,this.surveyRef=o.surveyRef;var l=ne.parse(window.location.search);l&&(this.openId=l.openId,this.token=l["sk-token"]),this.makeObservable(),this.loadProject(),this.confirmTempAnswerType=(e=this.savedAnswer)!==null&&e!==void 0&&e.progress?1:0}return(0,Le.Z)(y,[{key:"makeObservable",value:function(){(0,s.Ou)(this,{id:s.LO.ref,answerId:s.LO.ref,survey:s.LO.ref,loading:s.LO.ref,saving:s.LO.ref,verifying:s.LO.ref,project:s.LO.ref,errorCode:s.LO.ref,errorMessage:s.LO.ref,progress:s.LO.ref,confirmTempAnswerType:s.LO.ref,statistics:s.LO.ref,answerUrl:s.LO.ref,answerQrCodeUrl:s.LO.ref,success:s.LO.ref,answerView:s.LO.ref,values:s.LO.ref,loginRequired:s.LO.ref,whitelistName:s.LO.ref,openId:s.LO.ref,token:s.LO.ref,passwordRequired:s.LO.computed,mode:s.LO.computed,tempSaveId:s.LO.computed,status:s.LO.computed,setting:s.LO.computed,tempSave:s.aD,saveData:s.aD,loadProject:s.aD,changeProgress:s.aD,validate:s.aD})}},{key:"setting",get:function(){var e;return(e=this.project)===null||e===void 0?void 0:e.setting}},{key:"status",get:function(){var e;return(e=this.project)===null||e===void 0?void 0:e.status}},{key:"passwordRequired",get:function(){var e;return(e=this.project)===null||e===void 0?void 0:e.passwordRequired}},{key:"mode",get:function(){var e;return(e=this.project)===null||e===void 0?void 0:e.mode}},{key:"tempSaveId",get:function(){return"savedAnswer-"+this.id}},{key:"savedAnswer",get:function(){var e=localStorage.getItem(this.tempSaveId);return e&&JSON.parse(e)}},{key:"startTime",get:function(){var e,l,i;return((e=this.savedAnswer)===null||e===void 0||(l=e.metaInfo)===null||l===void 0||(i=l.answerInfo)===null||i===void 0?void 0:i.startTime)||new Date().getTime()}},{key:"tempSave",value:function(e){var l=localStorage.getItem(this.tempSaveId),i;l?(i=JSON.parse(l),i.answer=e,i.progress=this.progress):i={answer:e,metaInfo:{answerInfo:{startTime:new Date().getTime()}},progress:this.progress},localStorage.setItem(this.tempSaveId,JSON.stringify(i))}},{key:"saveData",value:function(){var o=(0,D.Z)((0,j.Z)().mark(function l(i,u){var g,n,h=this,C,x,I,m,a,R,F,V,L;return(0,j.Z)().wrap(function(v){for(;;)switch(v.prev=v.next){case 0:if(C=u||{},x=C.answerId,I=C.forceSubmit,this.saving=!0,m=new(Te())().getResult(),a={answer:i,projectId:this.id,metaInfo:{answerInfo:{startTime:this.startTime,endTime:new Date().getTime()},clientInfo:{browser:m.browser.name||"",browserVersion:m.browser.version||"",deviceType:m.device.type||"",platform:m.os.name||"",platformVersion:m.os.version||""}},id:x||this.answerId,whitelistName:this.whitelistName},R=this.startTime,F=((g=this.project)===null||g===void 0||(n=g.setting.examSetting)===null||n===void 0?void 0:n.minSubmitMinutes)||0,V=R+F*60*1e3,!(F>0&&new Date().getTime()<V&&I!==!0)){v.next=11;break}return se.default.error("\u672A\u5230\u4EA4\u5377\u65F6\u95F4"),this.saving=!1,v.abrupt("return");case 11:return v.next=13,b.hi.post(this.getUrlWithToken("/api/public/saveAnswer"),a);case 13:return L=v.sent,(0,s.aD)(function(){L.success&&(L.data.answerId?h.answerId=L.data.answerId:L.data.examScore!==void 0,h.answerView=L.data,h.values=i,h.success=!0,localStorage.removeItem(h.tempSaveId)),h.saving=!1}),v.abrupt("return",L);case 16:case"end":return v.stop()}},l,this)}));function e(l,i){return o.apply(this,arguments)}return e}()},{key:"loadStatistics",value:function(){var o=(0,D.Z)((0,j.Z)().mark(function l(){var i=this,u;return(0,j.Z)().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(!this.loading){n.next=2;break}return n.abrupt("return");case 2:return this.loading=!0,n.next=5,b.hi.post(this.getUrlWithToken("/api/public/statistics"),{id:this.id});case 5:u=n.sent,(0,s.aD)(function(){u.success&&(i.statistics=u.data),i.loading=!1});case 7:case"end":return n.stop()}},l,this)}));function e(){return o.apply(this,arguments)}return e}()},{key:"loadProject",value:function(){var o=(0,D.Z)((0,j.Z)().mark(function l(){var i=this,u;return(0,j.Z)().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return this.loading=!0,n.next=3,b.hi.post(this.getUrlWithToken("/api/public/loadProject"),{id:this.id,answerId:this.answerId});case 3:u=n.sent,(0,s.aD)(function(){u.success?(i.project=u.data,i.loginRequired=u.data.loginRequired,i.survey=u.data.survey,i.values=u.data.answer,u.data.answerId&&(i.answerId=u.data.answerId)):i.errorMessage=u.message,i.errorCode=u.code,i.loading=!1});case 5:case"end":return n.stop()}},l,this)}));function e(){return o.apply(this,arguments)}return e}()},{key:"validate",value:function(){var o=(0,D.Z)((0,j.Z)().mark(function l(i){var u=this,g;return(0,j.Z)().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:return this.verifying=!0,h.next=3,b.hi.post(this.getUrlWithToken("/api/public/validateProject"),{id:this.id,answer:i,answerId:this.answerId});case 3:g=h.sent,(0,s.aD)(function(){if(g.success){var C;u.project=g.data,u.loginRequired=!1,u.survey=g.data.survey,u.whitelistName=(C=i.whitelistName)===null||C===void 0?void 0:C.whitelistName}else se.default.error(g.message);u.verifying=!1});case 5:case"end":return h.stop()}},l,this)}));function e(l){return o.apply(this,arguments)}return e}()},{key:"upload",value:function(){var o=(0,D.Z)((0,j.Z)().mark(function l(i,u){return(0,j.Z)().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",b.hi.upload("/api/public/upload",(0,S.Z)({fileType:4,basePath:this.id},i),u));case 1:case"end":return n.stop()}},l,this)}));function e(l,i){return o.apply(this,arguments)}return e}()},{key:"changeProgress",value:function(e){this.progress=e}},{key:"getUrlWithToken",value:function(e){return ne.stringifyUrl({url:e,query:{"sk-token":this.token}})}}]),y}(),ae=(0,N.Pi)(function(){var y,o,e,l,i=(0,W.UO)(),u=i.id,g=i.answerId,n=(0,W.TH)(),h=n.query.preview==="1",C=n.query.pattern,x=n.query.openid,I=(0,f.useMemo)(function(){return(0,O.SB)()},[]),m=(0,f.useRef)(null),a=(0,f.useMemo)(function(){return new Ze({surveyRef:m,id:u,answerId:g})},[m,u,g]),R=a.saving,F=a.loading,V=(y=a.setting)===null||y===void 0?void 0:y.answerSetting,L=a.loginRequired,U=a.verifying,v=V||{},Q=v.autoSave,A=v.progressBar,E=v.initialValues,K=v.questionNumber,J=v.wechatOnly,_=v.onePageOneQuestion,oe=v.answerSheetVisible,ee=v.triggerType,Ae=v.copyEnabled,ue=((o=a.setting)===null||o===void 0?void 0:o.examSetting)||{},be=ue.exerciseMode,M=ue.maxSwitchScreenTimes,Fe=!!((e=a.setting)!==null&&e!==void 0&&(l=e.examSetting)!==null&&l!==void 0&&l.randomSurveyWrong),ke=a.errorMessage,re=a.savedAnswer,le=a.confirmTempAnswerType,Pe=a.statistics,B=a.survey,de=a.answerId,ve=a.mode,ce=a.success,fe=(0,O.XO)(B,n);(0,f.useEffect)(function(){B&&(0,O.iq)(B,"statEnabled","quota")&&a.loadStatistics()},[B,a]);var Re=(0,f.useCallback)(function(T,p){A&&a.changeProgress(p),Q&&T&&a.tempSave(T)},[A]),Me=function(){return(0,r.jsx)(Y.BW,{})};(0,f.useEffect)(function(){if(M!==void 0){var T=!1;window.onfocus=function(){T=!0},window.onblur=function(){if(!!T){var p="ebt-".concat(u),c=parseInt(localStorage.getItem(p)||"0")+1;if(c>M){var d,k=(d=m.current)===null||d===void 0?void 0:d.getValues();a.saveData((0,S.Z)((0,S.Z)({},k),{},{openid:x}),{forceSubmit:!0}).then(function(w){w!=null&&w.success&&localStorage.removeItem(p),!(w!=null&&w.success)&&w!==null&&w!==void 0&&w.message&&(I?$.u_.alert({title:"\u4FDD\u5B58\u5931\u8D25",content:(0,r.jsx)(z.Z,{html:w.message})}):P.Z.error({title:"\u4FDD\u5B58\u5931\u8D25",content:(0,r.jsx)(z.Z,{html:w.message}),okText:"\u77E5\u9053\u4E86"}))});return}console.log("lose focus ".concat(c)),I?$.u_.alert({header:(0,r.jsx)(xe,{style:{fontSize:64,color:"var(--adm-color-warning)"}}),title:"\u6CE8\u610F",content:(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)("div",{children:["\u6700\u591A\u53EF\u4EE5\u5207\u5C4F ",M," \u6B21\uFF0C\u68C0\u6D4B\u5230\u4F60\u5DF2\u5207\u6362\u4E86 ",c," \u6B21\uFF0C\u8D85\u8FC7",M," \u6B21\u95EE\u5377\u5C06\u5F3A\u5236\u63D0\u4EA4\u3002"]})})}):P.Z.warning({title:"\u63D0\u793A",content:"\u6700\u591A\u53EF\u4EE5\u5207\u5C4F ".concat(M," \u6B21\uFF0C\u68C0\u6D4B\u5230\u4F60\u5DF2\u5207\u6362\u4E86 ").concat(c," \u6B21\uFF0C\u8D85\u8FC7 ").concat(M," \u6B21\u95EE\u5377\u5C06\u5F3A\u5236\u63D0\u4EA4\u3002"),okText:"\u6211\u77E5\u9053\u4E86"}),localStorage.setItem(p,"".concat(c))}}}},[M]);var he=function(p){var c,d;return(0,r.jsxs)("div",{className:"render-failure ".concat(I?"mobile":"phone"),children:[((c=a.project)===null||c===void 0?void 0:c.name)&&(0,r.jsx)("div",{className:"title",children:(d=a.project)===null||d===void 0?void 0:d.name}),(0,r.jsxs)("div",{className:"content",children:[(0,r.jsx)("div",{children:(0,r.jsx)(Y.AT,{})}),(0,r.jsx)("h2",{children:ke||p}),(0,r.jsx)("div",{children:"\u611F\u8C22\u5173\u6CE8\uFF01"})]})]})},$e=function(){if(ce)return(0,r.jsx)(r.Fragment,{});if(F)return(0,r.jsx)(X.Z,{});if(a.errorCode!==200)return he();if(J&&!(0,O.CL)())return he("\u53EA\u80FD\u5728\u5FAE\u4FE1\u4E2D\u6253\u5F00");if(L)return(0,r.jsx)("div",{children:Me()});if(B&&!ce&&!U)return le===1&&Q&&ve==="survey"&&!de?(0,r.jsx)(Y.oq,{}):(0,r.jsx)("div",{style:{userSelect:Ae===!1?"none":"unset"},children:(0,r.jsx)(ie.Z,{ref:m,mode:ve,loading:R||F,progressBar:A,questionNumber:K,theme:I?"antdMobile":"antd",schema:B,onChange:Re,onePageOneQuestion:_,answerSheetVisible:oe,exerciseMode:be,wrongMode:Fe,pattern:C,triggerType:ee,onInit:function(c){a.tempSave(c.values)},onDictSearch:function(){var p=(0,D.Z)((0,j.Z)().mark(function c(d){var k;return(0,j.Z)().wrap(function(Z){for(;;)switch(Z.prev=Z.next){case 0:return Z.next=2,b.hi.loadDict(d);case 2:if(k=Z.sent,!k.success){Z.next=5;break}return Z.abrupt("return",k.data);case 5:return Z.abrupt("return",[]);case 6:case"end":return Z.stop()}},c)}));return function(c){return p.apply(this,arguments)}}(),initialValues:le===3?fe:(0,S.Z)((0,S.Z)((0,S.Z)((0,S.Z)({},E),Q?re==null?void 0:re.answer:{}),fe),a.values),statistics:Pe,onUpload:function(c,d){return a.upload(c,d)},footerVisible:!(h||C==="readPretty"),headerVisible:!h,isPreview:h,onLink:function(c){b.hi.loadLinkResult((0,S.Z)((0,S.Z)({},c),{},{projectId:u})).then(function(d){if(d.success&&d.data.answer){var k=d.data.answer;Object.keys(k).forEach(function(w){var Z=k[w];if(c.questionId!==w){var te;(te=m.current)===null||te===void 0||te.setValue(w,Z)}})}})},onSubmit:function(c){a.saveData((0,S.Z)((0,S.Z)({},c),{},{openid:x}),{answerId:de}).then(function(d){!(d!=null&&d.success)&&d!==null&&d!==void 0&&d.message&&(I?$.u_.alert({title:"\u4FDD\u5B58\u5931\u8D25",content:(0,r.jsx)(z.Z,{html:d.message})}):P.Z.error({title:"\u4FDD\u5B58\u5931\u8D25",content:(0,r.jsx)(z.Z,{html:d.message}),okText:"\u77E5\u9053\u4E86"}))})}})})},Ve=function(){return(0,r.jsx)(Ce,{})},Ue=function(){var p,c,d=(p=a.survey)===null||p===void 0||(c=p.attribute)===null||c===void 0?void 0:c.backgroundImage;if(d)return{backgroundImage:"url(/api/public/preview/".concat(d,")")}};return(0,r.jsx)(O.ff.Provider,{value:a,children:(0,r.jsxs)("div",{className:"survey ".concat(I?"mobile":"pc"),style:Ue(),children:[$e(),Ve()]})})}),De=ae}}]);
